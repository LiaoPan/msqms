<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="MEG quality summary report generated by msqms">
    <meta name="author" content="LiaoPan">
    <title>{{ title | striptags }}</title>
    <link rel="icon" href='data:image/png;base64,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'/>
    {% include 'style.html' %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .summary-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-weight: 600;
            color: #495057;
        }
        .stat-value {
            color: #667eea;
            font-weight: 600;
        }
        .chart-container {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-container h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .report-list {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .report-item:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }
        .report-item.active {
            background: #e3f2fd;
            border-color: #667eea;
        }
        .report-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .report-score {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }
        .report-viewer {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            min-height: 600px;
        }
        .report-viewer iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 4px;
        }
        .no-report-selected {
            text-align: center;
            padding: 100px 20px;
            color: #6c757d;
        }
        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .score-excellent { background: #4fb332; color: #fff; }
        .score-good { background: #88cecf; color: #fff; }
        .score-fair { background: #2ab9cd; color: #fff; }
        .score-poor { background: #f5af30; color: #fff; }
        .score-bad { background: #e52f10; color: #fff; }
        .chart-controls {
            display: flex;
            gap: 5px;
        }
        .chart-btn {
            padding: 6px 12px;
            border: 1px solid #667eea;
            background: #fff;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .chart-btn:hover {
            background: #f0f4ff;
        }
        .chart-btn.active {
            background: #667eea;
            color: #fff;
        }
        #reports-container {
            max-height: 600px;
            overflow-y: auto;
        }
        #reports-container::-webkit-scrollbar {
            width: 8px;
        }
        #reports-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #reports-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        .report-item.hidden {
            display: none;
        }
    </style>
</head>

<body>
<div class="bootstrap-iso">
    {% if nav == True %}
    {% include 'navigation.html' %}
    {% endif %}

    <div class="qc_report_wrap">
        <div class="tab-content">
            <!-- Summary Tab -->
            <div class="tab-pane active" id="summary">
                <div class="summary-container">
                    <!-- Summary Statistics -->
                    <div class="stats-card">
                        <h3>Summary Statistics</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Files:</span>
                            <span class="stat-value">{{ total_files }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">MSQM Score Mean:</span>
                            <span class="stat-value">{{ "%.2f"|format(summary_stats.statistics.msqm_mean * 100) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">MSQM Score Std:</span>
                            <span class="stat-value">{{ "%.2f"|format(summary_stats.statistics.msqm_std * 100) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">MSQM Score Min:</span>
                            <span class="stat-value">{{ "%.2f"|format(summary_stats.statistics.msqm_min * 100) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">MSQM Score Max:</span>
                            <span class="stat-value">{{ "%.2f"|format(summary_stats.statistics.msqm_max * 100) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">MSQM Score Median:</span>
                            <span class="stat-value">{{ "%.2f"|format(summary_stats.statistics.msqm_median * 100) }}%</span>
                        </div>
                    </div>

                    <!-- MSQM Scores Distribution Chart -->
                    <div class="chart-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">MSQM Scores Distribution</h3>
                            <div class="chart-controls" id="chart-controls-msqm">
                                <button class="chart-btn active" onclick="switchChartView('msqm', 'bar')">Bar Chart</button>
                                <button class="chart-btn" onclick="switchChartView('msqm', 'box')">Violin Plot</button>
                                <button class="chart-btn" onclick="switchChartView('msqm', 'histogram')">Histogram</button>
                            </div>
                        </div>
                        <div id="msqm-chart"></div>
                    </div>

                    <!-- Category Scores Distribution Charts -->
                    {% for category, data in category_scores_data.items() %}
                    <div class="chart-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">{{ data.display_name }} Distribution</h3>
                            <div class="chart-controls" id="chart-controls-{{ category }}">
                                <button class="chart-btn active" onclick="switchChartView('{{ category }}', 'bar')">Bar Chart</button>
                                <button class="chart-btn" onclick="switchChartView('{{ category }}', 'box')">Violin Plot</button>
                                <button class="chart-btn" onclick="switchChartView('{{ category }}', 'histogram')">Histogram</button>
                            </div>
                        </div>
                        <div id="category-chart-{{ category }}"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Individual Reports Tab -->
            <div class="tab-pane" id="individual">
                <div class="summary-container">
                    <div class="report-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h3 style="margin: 0; color: #667eea; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; flex: 1;">
                                Individual Reports ({{ total_files }} files)
                            </h3>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="report-search" placeholder="Search files..." 
                                       style="padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; font-size: 14px; min-width: 200px;"
                                       onkeyup="filterReports()">
                                <select id="report-sort" onchange="sortReports()" 
                                        style="padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; font-size: 14px;">
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                    <option value="score-desc">Score (High to Low)</option>
                                    <option value="score-asc">Score (Low to High)</option>
                                </select>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <select id="score-filter-op" onchange="filterReports()" 
                                            style="padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; font-size: 14px; width: 80px;">
                                        <option value="">All</option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                        <option value=">">&gt;</option>
                                        <option value="<">&lt;</option>
                                        <option value="=">=</option>
                                    </select>
                                    <input type="number" id="score-filter-value" placeholder="Score" 
                                           min="0" max="100" step="0.01"
                                           style="padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; font-size: 14px; width: 80px;"
                                           onkeyup="filterReports()" onchange="filterReports()">
                                </div>
                                <button onclick="exportFilteredReports()" 
                                        style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; white-space: nowrap;"
                                        onmouseover="this.style.background='#5568d3'" 
                                        onmouseout="this.style.background='#667eea'">
                                    Export TXT
                                </button>
                                <div style="font-size: 12px; color: #6c757d;">
                                    Showing <span id="report-count">{{ total_files }}</span> files
                                </div>
                            </div>
                        </div>
                        <div id="reports-container">
                            {% for report in reports %}
                            <div class="report-item" data-filename="{{ report.filename|lower }}" data-score="{{ report.msqm_score }}" data-filepath="{{ report.filepath }}" onclick="loadReport('{{ report.report_path }}', this)">
                                <div>
                                    <div class="report-name">{{ report.filename }}</div>
                                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">{{ report.filepath }}</div>
                                </div>
                                <div>
                                    <div class="report-score">{{ "%.2f"|format(report.msqm_score * 100) }}%</div>
                                    {% set score_pct = report.msqm_score * 100 %}
                                    {% if score_pct >= 90 %}
                                        <span class="score-badge score-excellent">Excellent</span>
                                    {% elif score_pct >= 80 %}
                                        <span class="score-badge score-good">Good</span>
                                    {% elif score_pct >= 60 %}
                                        <span class="score-badge score-fair">Fair</span>
                                    {% elif score_pct >= 40 %}
                                        <span class="score-badge score-poor">Poor</span>
                                    {% else %}
                                        <span class="score-badge score-bad">Bad</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="report-viewer" id="report-viewer">
                        <div class="no-report-selected">
                            <h3>Select a report from the list above to view details</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'footer.html' %}
{% include 'javascript.html' %}

<script>
    // MSQM Scores Distribution Chart
    var msqmData = {
        x: {{ msqm_scores_data['labels'] | tojson }},
        y: {{ msqm_scores_data['values'] | tojson }},
        type: 'bar',
        marker: {
            color: {{ msqm_scores_data['values'] | tojson }},
            colorscale: [
                [0, '#e52f10'],
                [0.4, '#f5af30'],
                [0.6, '#2ab9cd'],
                [0.8, '#88cecf'],
                [1, '#4fb332']
            ],
            showscale: true,
            colorbar: {
                title: 'Score (%)',
                titleside: 'right'
            }
        }
    };

    var msqmLayout = {
        title: 'MSQM Scores by File',
        xaxis: { title: 'File Name', tickangle: -45 },
        yaxis: { title: 'Score (%)', range: [0, 100] },
        margin: { b: 150 },
        shapes: [{
            type: 'line',
            x0: -0.5,
            y0: {{ msqm_scores_data['mean'] }},
            x1: {{ msqm_scores_data['values'] | length - 0.5 }},
            y1: {{ msqm_scores_data['mean'] }},
            line: {
                color: 'red',
                width: 2,
                dash: 'dash'
            }
        }],
        annotations: [{
            x: {{ (msqm_scores_data['values'] | length - 1) / 2 }},
            y: {{ msqm_scores_data['mean'] }},
            text: 'Mean: {{ "%.2f"|format(msqm_scores_data['mean']) }}%',
            showarrow: true,
            arrowhead: 2,
            arrowcolor: 'red'
        }]
    };

    // Store chart data and layouts for switching
    var chartData = {
        'msqm': {
            values: {{ msqm_scores_data['values'] | tojson }},
            labels: {{ msqm_scores_data['labels'] | tojson }},
            mean: {{ msqm_scores_data['mean'] }},
            std: {{ msqm_scores_data['std'] }},
            min: {{ msqm_scores_data['min'] }},
            max: {{ msqm_scores_data['max'] }},
            median: {{ msqm_scores_data['median'] }}
        }
    };
    
    var chartLayouts = {
        'msqm': msqmLayout
    };
    
    var currentChartView = {
        'msqm': 'bar'
    };
    
    // Auto-switch to box plot if too many files
    var fileCount = {{ total_files }};
    if (fileCount > 20) {
        currentChartView['msqm'] = 'box';
        switchChartView('msqm', 'box');
    } else {
        Plotly.newPlot('msqm-chart', [msqmData], msqmLayout, {responsive: true});
    }

    // Category Scores Distribution Charts
    {% for category, data in category_scores_data.items() %}
    var categoryData{{ category|replace('-', '_') }} = {
        x: {{ data['labels'] | tojson }},
        y: {{ data['values'] | tojson }},
        type: 'bar',
        marker: {
            color: {{ data['values'] | tojson }},
            colorscale: [
                [0, '#e52f10'],
                [0.4, '#f5af30'],
                [0.6, '#2ab9cd'],
                [0.8, '#88cecf'],
                [1, '#4fb332']
            ],
            showscale: true,
            colorbar: {
                title: 'Score (%)',
                titleside: 'right'
            }
        }
    };

    var categoryLayout{{ category|replace('-', '_') }} = {
        title: '{{ data['display_name'] }} Scores by File',
        xaxis: { title: 'File Name', tickangle: -45 },
        yaxis: { title: 'Score (%)', range: [0, 100] },
        margin: { b: 150 },
        shapes: [{
            type: 'line',
            x0: -0.5,
            y0: {{ data['mean'] }},
            x1: {{ data['values'] | length - 0.5 }},
            y1: {{ data['mean'] }},
            line: {
                color: 'red',
                width: 2,
                dash: 'dash'
            }
        }],
        annotations: [{
            x: {{ (data['values'] | length - 1) / 2 }},
            y: {{ data['mean'] }},
            text: 'Mean: {{ "%.2f"|format(data['mean']) }}%',
            showarrow: true,
            arrowhead: 2,
            arrowcolor: 'red'
        }]
    };

    // Store category chart data
    chartData['{{ category }}'] = {
        values: {{ data['values'] | tojson }},
        labels: {{ data['labels'] | tojson }},
        mean: {{ data['mean'] }},
        std: {{ data['std'] }},
        min: {{ data['min'] }},
        max: {{ data['max'] }},
        median: {{ data['median'] }},
        display_name: '{{ data['display_name'] }}'
    };
    
    chartLayouts['{{ category }}'] = categoryLayout{{ category|replace('-', '_') }};
    currentChartView['{{ category }}'] = 'bar';
    
    // Auto-switch to box plot if too many files
    if (fileCount > 20) {
        currentChartView['{{ category }}'] = 'box';
        switchChartView('{{ category }}', 'box');
    } else {
        Plotly.newPlot('category-chart-{{ category }}', [categoryData{{ category|replace('-', '_') }}], categoryLayout{{ category|replace('-', '_') }}, {responsive: true});
    }
    {% endfor %}
    
    // Chart view switching function
    function switchChartView(chartId, viewType) {
        var data = chartData[chartId];
        var chartDiv = chartId === 'msqm' ? 'msqm-chart' : 'category-chart-' + chartId;
        var chartTitle = chartId === 'msqm' ? 'MSQM Scores' : data.display_name;
        
        // Update button states
        var controlDiv = document.getElementById('chart-controls-' + chartId);
        if (controlDiv) {
            var buttons = controlDiv.querySelectorAll('.chart-btn');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
                var btnText = btn.textContent.trim();
                if ((viewType === 'bar' && btnText.includes('Bar')) ||
                    (viewType === 'box' && btnText.includes('Box')) ||
                    (viewType === 'histogram' && btnText.includes('Histogram'))) {
                    btn.classList.add('active');
                }
            });
        }
        
        currentChartView[chartId] = viewType;
        
        var plotData, layout;
        
        if (viewType === 'bar') {
            // Bar chart
            plotData = [{
                x: data.labels,
                y: data.values,
                type: 'bar',
                marker: {
                    color: data.values,
                    colorscale: [
                        [0, '#e52f10'],
                        [0.4, '#f5af30'],
                        [0.6, '#2ab9cd'],
                        [0.8, '#88cecf'],
                        [1, '#4fb332']
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Score (%)',
                        titleside: 'right'
                    }
                }
            }];
            
            layout = {
                title: chartTitle + ' by File',
                xaxis: { 
                    title: 'File Name', 
                    tickangle: fileCount > 15 ? -90 : -45,
                    automargin: true
                },
                yaxis: { title: 'Score (%)', range: [0, 100] },
                margin: { b: fileCount > 15 ? 200 : 150 },
                shapes: [{
                    type: 'line',
                    x0: -0.5,
                    y0: data.mean,
                    x1: data.values.length - 0.5,
                    y1: data.mean,
                    line: {
                        color: 'red',
                        width: 2,
                        dash: 'dash'
                    }
                }],
                annotations: [{
                    x: (data.values.length - 1) / 2,
                    y: data.mean,
                    text: 'Mean: ' + data.mean.toFixed(2) + '%',
                    showarrow: true,
                    arrowhead: 2,
                    arrowcolor: 'red'
                }]
            };
        } else if (viewType === 'box') {
            // Enhanced Violin plot with box plot overlay and individual points
            // Calculate statistics
            var sortedValues = data.values.slice().sort(function(a, b) { return a - b; });
            var q1 = sortedValues[Math.floor(sortedValues.length * 0.25)];
            var median = sortedValues[Math.floor(sortedValues.length * 0.5)];
            var q3 = sortedValues[Math.floor(sortedValues.length * 0.75)];
            var iqr = q3 - q1;
            var lowerWhisker = Math.max(sortedValues[0], q1 - 1.5 * iqr);
            var upperWhisker = Math.min(sortedValues[sortedValues.length - 1], q3 + 1.5 * iqr);
            
            // Create plot data with violin plot only (no box plot)
            plotData = [
                {
                    y: data.values,
                    type: 'violin',
                    name: chartTitle,
                    side: 'positive',
                    width: 0.6,
                    box: {
                        visible: false
                    },
                    meanline: {
                        visible: false
                    },
                    fillcolor: 'rgba(173, 216, 230, 0.4)',
                    line: {
                        color: 'rgba(135, 206, 250, 0.7)',
                        width: 1.5
                    },
                    points: 'all',
                    pointpos: 0,
                    jitter: 0.4,
                    marker: {
                        color: 'rgba(135, 206, 250, 0.7)',
                        size: 5,
                        line: {
                            color: 'rgba(100, 149, 237, 0.9)',
                            width: 0.7
                        },
                        symbol: 'circle',
                        opacity: 0.8
                    },
                    showlegend: false,
                    hoveron: 'violins+points',
                    scalegroup: '',
                    scalemode: 'width'
                }
            ];
            
            // Create annotations for statistics - cleaner style
            var annotations = [
                {
                    x: 0.25,
                    y: data.mean,
                    text: '<b>Mean: ' + data.mean.toFixed(2) + '%</b>',
                    showarrow: true,
                    arrowhead: 2,
                    arrowcolor: '#dc3545',
                    arrowsize: 1.2,
                    arrowwidth: 2.5,
                    ax: 0,
                    ay: -35,
                    bgcolor: 'rgba(255, 255, 255, 0.98)',
                    bordercolor: '#dc3545',
                    borderwidth: 2,
                    borderpad: 5,
                    xref: 'x',
                    yref: 'y',
                    font: { 
                        size: 13,
                        color: '#dc3545',
                        family: 'Arial, sans-serif'
                    }
                }
            ];
            
            // Add Q1 annotation
            if (q1 !== median) {
                annotations.push({
                    x: -0.25,
                    y: q1,
                    text: 'Q1: ' + q1.toFixed(2) + '%',
                    showarrow: false,
                    xanchor: 'right',
                    bgcolor: 'rgba(255, 255, 255, 0.98)',
                    bordercolor: '#1e3a8a',
                    borderwidth: 2,
                    borderpad: 3,
                    xref: 'x',
                    yref: 'y',
                    font: { 
                        size: 11,
                        color: '#1e3a8a',
                        family: 'Arial, sans-serif'
                    }
                });
            }
            
            // Add Q3 annotation
            if (q3 !== median) {
                annotations.push({
                    x: -0.25,
                    y: q3,
                    text: 'Q3: ' + q3.toFixed(2) + '%',
                    showarrow: false,
                    xanchor: 'right',
                    bgcolor: 'rgba(255, 255, 255, 0.98)',
                    bordercolor: '#1e3a8a',
                    borderwidth: 2,
                    borderpad: 3,
                    xref: 'x',
                    yref: 'y',
                    font: { 
                        size: 11,
                        color: '#1e3a8a',
                        family: 'Arial, sans-serif'
                    }
                });
            }
            
            // Add Median annotation on the left
            annotations.push({
                x: -0.25,
                y: median,
                text: '<b>Median: ' + median.toFixed(2) + '%</b>',
                showarrow: false,
                xanchor: 'right',
                bgcolor: 'rgba(255, 255, 255, 0.98)',
                bordercolor: '#1e3a8a',
                borderwidth: 2,
                borderpad: 4,
                xref: 'x',
                yref: 'y',
                font: { 
                    size: 12,
                    color: '#1e3a8a',
                    family: 'Arial, sans-serif'
                }
            });
            
            layout = {
                title: {
                    text: chartTitle + ' Distribution',
                    font: {
                        size: 18,
                        family: 'Arial, sans-serif',
                        color: '#2c3e50',
                        weight: 'bold'
                    },
                    x: 0.5,
                    xanchor: 'center'
                },
                xaxis: { 
                    showticklabels: false,
                    showgrid: false,
                    zeroline: false,
                    range: [-0.3, 0.3],
                    fixedrange: true
                },
                yaxis: { 
                    title: {
                        text: 'Score (%)',
                        font: {
                            size: 14,
                            family: 'Arial, sans-serif',
                            color: '#495057'
                        },
                        standoff: 10
                    },
                    range: [Math.max(0, data.min - 2), Math.min(100, data.max + 2)],
                    showgrid: true,
                    gridcolor: 'rgba(0, 0, 0, 0.12)',
                    gridwidth: 1,
                    griddash: 'dash',
                    zeroline: false,
                    tickfont: {
                        size: 12,
                        color: '#6c757d',
                        family: 'Arial, sans-serif'
                    },
                    tickmode: 'linear',
                    dtick: 5
                },
                showlegend: false,
                margin: { l: 75, r: 25, t: 70, b: 50 },
                plot_bgcolor: 'rgba(255, 255, 255, 1)',
                paper_bgcolor: 'rgba(255, 255, 255, 1)',
                annotations: annotations,
                shapes: [
                    // Q1 line (horizontal) - make it more visible
                    {
                        type: 'line',
                        x0: -0.25,
                        y0: q1,
                        x1: 0.25,
                        y1: q1,
                        line: {
                            color: '#1e3a8a',
                            width: 2.5
                        },
                        layer: 'above',
                        xref: 'x',
                        yref: 'y'
                    },
                    // Median line (horizontal) - thicker
                    {
                        type: 'line',
                        x0: -0.25,
                        y0: median,
                        x1: 0.25,
                        y1: median,
                        line: {
                            color: '#1e3a8a',
                            width: 3
                        },
                        layer: 'above',
                        xref: 'x',
                        yref: 'y'
                    },
                    // Q3 line (horizontal) - make it more visible
                    {
                        type: 'line',
                        x0: -0.25,
                        y0: q3,
                        x1: 0.25,
                        y1: q3,
                        line: {
                            color: '#1e3a8a',
                            width: 2.5
                        },
                        layer: 'above',
                        xref: 'x',
                        yref: 'y'
                    },
                    // Mean line (red dashed)
                    {
                        type: 'line',
                        x0: -0.3,
                        y0: data.mean,
                        x1: 0.3,
                        y1: data.mean,
                        line: {
                            color: '#dc3545',
                            width: 2.5,
                            dash: 'dash'
                        },
                        layer: 'below',
                        opacity: 0.8,
                        xref: 'x',
                        yref: 'y'
                    }
                ],
                hovermode: 'closest'
            };
        } else {
            // Histogram
            plotData = [{
                x: data.values,
                type: 'histogram',
                nbinsx: Math.min(20, Math.ceil(Math.sqrt(data.values.length))),
                marker: {
                    color: '#667eea',
                    line: {
                        color: '#fff',
                        width: 1
                    }
                }
            }];
            
            layout = {
                title: chartTitle + ' Distribution (Histogram)',
                xaxis: { 
                    title: 'Score (%)',
                    range: [0, 100]
                },
                yaxis: { title: 'Frequency' },
                shapes: [{
                    type: 'line',
                    x0: data.mean,
                    y0: 0,
                    x1: data.mean,
                    y1: 1,
                    xref: 'x',
                    yref: 'paper',
                    line: {
                        color: 'red',
                        width: 2,
                        dash: 'dash'
                    }
                }],
                annotations: [{
                    x: data.mean,
                    y: 0.95,
                    xref: 'x',
                    yref: 'paper',
                    text: 'Mean: ' + data.mean.toFixed(2) + '%',
                    showarrow: true,
                    arrowhead: 2,
                    arrowcolor: 'red'
                }]
            };
        }
        
        Plotly.newPlot(chartDiv, plotData, layout, {responsive: true});
    }
    
    // Search and filter reports
    function filterReports() {
        var searchTerm = document.getElementById('report-search').value.toLowerCase();
        var scoreFilterOp = document.getElementById('score-filter-op').value;
        var scoreFilterValue = parseFloat(document.getElementById('score-filter-value').value);
        var items = document.querySelectorAll('.report-item');
        var visibleCount = 0;
        
        items.forEach(function(item) {
            var filename = item.getAttribute('data-filename');
            var score = parseFloat(item.getAttribute('data-score')) * 100; // Convert to percentage
            
            // Check filename filter
            var filenameMatch = filename.includes(searchTerm);
            
            // Check score filter
            var scoreMatch = true;
            if (scoreFilterOp && !isNaN(scoreFilterValue)) {
                switch(scoreFilterOp) {
                    case '>=':
                        scoreMatch = score >= scoreFilterValue;
                        break;
                    case '<=':
                        scoreMatch = score <= scoreFilterValue;
                        break;
                    case '>':
                        scoreMatch = score > scoreFilterValue;
                        break;
                    case '<':
                        scoreMatch = score < scoreFilterValue;
                        break;
                    case '=':
                        scoreMatch = Math.abs(score - scoreFilterValue) < 0.01; // Allow small floating point differences
                        break;
                }
            }
            
            if (filenameMatch && scoreMatch) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        });
        
        document.getElementById('report-count').textContent = visibleCount;
    }
    
    // Sort reports
    function sortReports() {
        var sortValue = document.getElementById('report-sort').value;
        var container = document.getElementById('reports-container');
        var items = Array.from(container.querySelectorAll('.report-item'));
        
        items.sort(function(a, b) {
            if (sortValue === 'name-asc') {
                return a.getAttribute('data-filename').localeCompare(b.getAttribute('data-filename'));
            } else if (sortValue === 'name-desc') {
                return b.getAttribute('data-filename').localeCompare(a.getAttribute('data-filename'));
            } else if (sortValue === 'score-desc') {
                return parseFloat(b.getAttribute('data-score')) - parseFloat(a.getAttribute('data-score'));
            } else if (sortValue === 'score-asc') {
                return parseFloat(a.getAttribute('data-score')) - parseFloat(b.getAttribute('data-score'));
            }
            return 0;
        });
        
        // Re-append sorted items
        items.forEach(function(item) {
            container.appendChild(item);
        });
    }
    
    // Export filtered reports to TXT
    function exportFilteredReports() {
        var items = Array.from(document.querySelectorAll('.report-item:not(.hidden)'));
        
        if (items.length === 0) {
            alert('No reports to export. Please adjust your filters.');
            return;
        }
        
        // Get filter information
        var searchTerm = document.getElementById('report-search').value;
        var scoreFilterOp = document.getElementById('score-filter-op').value;
        var scoreFilterValue = document.getElementById('score-filter-value').value;
        
        // Build text content
        var lines = [];
        lines.push('MEG Quality Summary Report - Filtered Results');
        lines.push('='.repeat(60));
        lines.push('');
        lines.push('Export Date: ' + new Date().toLocaleString());
        lines.push('');
        
        // Filter criteria
        lines.push('Filter Criteria:');
        if (searchTerm) {
            lines.push('  Filename contains: ' + searchTerm);
        }
        if (scoreFilterOp && scoreFilterValue) {
            var opText = {
                '>=': '≥',
                '<=': '≤',
                '>': '>',
                '<': '<',
                '=': '='
            };
            lines.push('  Score ' + (opText[scoreFilterOp] || scoreFilterOp) + ' ' + scoreFilterValue + '%');
        }
        if (!searchTerm && (!scoreFilterOp || !scoreFilterValue)) {
            lines.push('  No filters applied (all reports)');
        }
        lines.push('');
        lines.push('Total Reports: ' + items.length);
        lines.push('');
        lines.push('='.repeat(60));
        lines.push('');
        
        // Report details
        lines.push('Report Details:');
        lines.push('-'.repeat(60));
        
        items.forEach(function(item, index) {
            var filename = item.querySelector('.report-name').textContent;
            var filepath = item.getAttribute('data-filepath') || item.querySelector('div[style*="font-size: 12px"]').textContent;
            var score = item.querySelector('.report-score').textContent;
            var badge = item.querySelector('.score-badge');
            var rating = badge ? badge.textContent : 'N/A';
            
            lines.push('');
            lines.push((index + 1) + '. ' + filename);
            lines.push('   File: ' + filepath);
            lines.push('   Score: ' + score);
            lines.push('   Rating: ' + rating);
        });
        
        lines.push('');
        lines.push('='.repeat(60));
        lines.push('End of Report');
        
        // Create and download file
        var content = lines.join('\n');
        var blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'meg_quality_filtered_reports_' + new Date().toISOString().slice(0, 10) + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load individual report
    function loadReport(reportPath, element) {
        // Remove active class from all items
        document.querySelectorAll('.report-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to clicked item
        element.classList.add('active');
        
        // Load report in iframe
        var viewer = document.getElementById('report-viewer');
        viewer.innerHTML = '<iframe src="' + reportPath + '"></iframe>';
    }
</script>

</body>
</html>

